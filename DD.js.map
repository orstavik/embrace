{"version":3,"file":"DD.js","sources":["src/DD.js"],"sourcesContent":["const dollarDots = {};\n\nfunction mapInnerDefs(innerHydras) {\n  const res = new Map();\n  for (let i = 0; i < innerHydras.length; i++) {\n    if (innerHydras[i].Def) {\n      res.set(innerHydras[i].Def, [[i]]);\n      for (let innerInnerDef of innerHydras[i].Def.innerDefs.keys()) {\n        const innerInnerDefPositions = res.get(innerInnerDef);\n        if (innerInnerDefPositions) {\n          const innerInnerDefPositionsFromOuterPointOfView = innerInnerDefPositions.map(pos => [i, ...pos]);\n          let myInnerInnerDefPositions = res.get(innerInnerDef);\n          myInnerInnerDefPositions ?\n            myInnerInnerDefPositions.push(...innerInnerDefPositionsFromOuterPointOfView) :\n            res.set(innerInnerDef, innerInnerDefPositionsFromOuterPointOfView);\n        }\n      }\n    }\n  }\n  return res;\n}\n\nexport function register(template) {\n  dollarDots[template.id] = template;\n  const el = document.createElement(\"template\");\n  el.innerHTML = template.templateString;\n  template.docFrag = el.content;\n  delete template.templateString;\n  template.innerHydras = template.innerHydras.map(({ id, path, hydra }) => ({\n    id,\n    path,\n    hydra,\n    Def: getDefinition(id),\n  }));\n  template.position = Object.keys(dollarDots).length;\n  template.innerDefs = mapInnerDefs(template.innerHydras);\n}\n\nexport function getDefinition(id) {\n  return dollarDots[id];\n}\n\nconst resolvePath = (root, path) => path.reduce((n, i) =>\n  typeof i == \"string\" ? n.getAttributeNode(i) : n.childNodes[i], root);\n\nexport function getInstance(Def) {\n  const root = Def.docFrag.cloneNode(true);\n  const start = root.firstChild;\n  const nodes = Def.innerHydras.map(({ path, Def }) => {\n    const start = resolvePath(root, path);\n    const end = Def ? start.nextSibling : undefined;\n    return { start, end };\n  });\n  const innerHydras = Def.innerHydras;\n  return { start, innerHydras, nodes };\n}\n\nexport function findEndComment(start) {\n  const commas = [];\n  for (let end = start.nextSibling, depth = 0; end; end = end.nextSibling)\n    if (end.nodeType === Node.COMMENT_NODE) {\n      const endTxt = end.nodeValue.trim();\n      if (!depth && endTxt == \"::\")\n        return { end, commas: [start, ...commas, end] };\n      if (!depth && endTxt == \"::,\")\n        commas.push(end);\n      if (endTxt == \"::\")\n        depth--;\n      else if (endTxt.startsWith(\":: \"))\n        depth++;\n    }\n}\n\nexport function* findDollarDots(node) {\n  const traverser = document.createTreeWalker(node, NodeFilter.SHOW_ALL, null, false);\n  for (let node; node = traverser.nextNode();) {\n    const txt = node.nodeValue?.trim();\n    if (node.nodeType === Node.COMMENT_NODE && txt.startsWith(\":: \")) {\n      const id = txt.match(/^::\\s+(id_[0-9a-f]{32})\\s*$/i)?.[1];\n      let { end, commas } = findEndComment(node) ?? {};\n      if (!end) { //implicit close at endOf siblings\n        end = document.createComment(\"::\");\n        node.parentNode.append(end);\n      }\n      const templ = { start: node, end, commas, id };\n      traverser.currentNode = templ.end;\n      yield templ;\n    } else if (node.nodeType === Node.ELEMENT_NODE) {\n      for (let attr of node.attributes)\n        if (attr.value.indexOf(\"${\") >= 0)\n          yield { start: attr };\n    } else if (txt.indexOf(\"${\") >= 0)\n      yield { start: node };\n  }\n}\n\nexport function* findRunnableTemplates(root) {\n  for (let n of findDollarDots(root))\n    if (n.id)   //todo we need to retry not yet available templates\n      yield n;\n}"],"names":[],"mappings":"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"}