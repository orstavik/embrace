<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>28 - Routing Demo</title>
    <style>
        :root {
            --bg: #0f172a;
            --card: #1e293b;
            --text: #f1f5f9;
            --accent: #38bdf8;
            --border: #334155;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        nav {
            background: #1e293b;
            padding: 20px 40px;
            border-bottom: 2px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        nav .logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--accent);
        }

        nav .links {
            display: flex;
            gap: 20px;
        }

        nav a {
            color: #94a3b8;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.2s;
        }

        nav a:hover,
        nav a.active {
            color: var(--accent);
        }

        main {
            flex: 1;
            padding: 40px;
            max-width: 800px;
            margin: 0 auto;
            width: 100%;
        }

        .page {
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .loading {
            color: var(--accent);
            font-style: italic;
        }
    </style>
</head>

<body>
    <nav>
        <div class="logo">EmbraceRouter</div>
        <div class="links">
            <a href="#/" id="nav-home">Home</a>
            <a href="#/about" id="nav-about">About</a>
        </div>
    </nav>

    <main id="view">
        <div class="loading">Loading router...</div>
    </main>

    <!-- Placeholder for Compiled template modules -->
    <script type="module" id="DollarDotsCompile"></script>

    <script type="module">
        import { compile } from "/src/DDCompile6.js";
        import { renderUnder } from "/src/DDRender61.js";

        let appData = {};
        const viewRoot = document.getElementById('view');

        const routes = {
            '/': './pages/home.html',
            '/about': './pages/about.html'
        };

        async function fetchTemplate(url) {
            // Bust cache for dev
            const resp = await fetch(url + '?t=' + Date.now());
            if (!resp.ok) throw new Error("File not found");
            const html = await resp.text();
            return html;
        }

        async function router() {
            let path = window.location.hash.slice(1) || '/';
            // handle root slash issue if any
            if (path === "") path = "/";

            const templateUrl = routes[path];

            // Update active nav links
            document.querySelectorAll('nav a').forEach(a => {
                const href = a.getAttribute('href');
                const cleanHref = href.startsWith('#') ? href.slice(1) : href;
                // Exact match or handle default
                let isActive = cleanHref === path;
                if (path === '/' && cleanHref === '/') isActive = true;

                a.classList.toggle('active', isActive);
            });

            if (!templateUrl) {
                viewRoot.innerHTML = `<div style="color: #ef4444">404 - Page Not Found</div>`;
                return;
            }

            viewRoot.innerHTML = '<div class="loading">Loading page...</div>';

            try {
                const template = await fetchTemplate(templateUrl);

                // Inject the template HTML (which contains DollarDots syntax)
                viewRoot.innerHTML = template;

                // Compile the new content
                // We use the existing mother script element to append definitions
                const motherScript = document.getElementById("DollarDotsCompile");
                compile(viewRoot, motherScript, "/src/DD6.js");

                // Render the data into the view
                renderUnder(viewRoot, appData);

            } catch (err) {
                console.error(err);
                viewRoot.innerHTML = `<div style="color: #ef4444">Error loading page: ${err.message}</div>`;
            }
        }

        async function init() {
            appData = {
                "site": {
                    "title": "Embrace Router",
                    "description": "Lightweight client-side routing demo."
                },
                "user": {
                    "name": "Lojith",
                    "role": "Developer"
                },
                "stats": {
                    "pages": 2,
                    "mode": "Hash Routing"
                }
            };

            window.addEventListener('hashchange', router);

            // Handle initial load
            await router();
        }

        init();
    </script>
</body>

</html>